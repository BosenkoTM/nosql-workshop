# Работа с GraphDB

В этом практическом занятии мы узнаем, как использовать базу данных `Ontotext GraphDB NoSQL`.

Предполагается, что платформа, описанная [здесь](../01-environment/README.md), запущена и доступна.

На этом занятии вы узнаете, как загружать данные в формате `RDF` в `GraphDB`, а затем использовать язык запросов `SPARQL` для выполнения запросов к данным.

**Цель занятия:**

Цель данного занятия — освоение работы с базой данных GraphDB в виртуальной машине с использованием Docker. Студенты научатся загружать RDF-данные в базу, выполнять запросы с использованием SPARQL и анализировать результаты, используя функциональность GraphDB.

**Задачи:**

1. Настроить и запустить контейнер с GraphDB с помощью Docker.
2. Загрузить RDF-данные о фильмах в базу данных.
3. Ознакомиться с основами SPARQL-запросов.
4. Выполнить различные SPARQL-запросы для получения информации из базы данных.
5. Проанализировать и интерпретировать результаты выполнения запросов.

**Необходимое ПО:**

- **Операционная система**: Ubuntu 22.
- **СУБД**: GraphDB.
- **Docker**: для запуска контейнера с GraphDB.
- **Среда разработки**: SPARQL редактор для выполнения запросов.

**Процесс начала работы:**

1. Подключитесь к виртуальной машине и войдите в нее.
2. Перейдите в каталог с проектом:
   ```
   cd ~/Downloads/dba/nonrel/graphdb
   ```
3. Остановите контейнер, если он работает:
   ```
   sudo docker compose stop
   ```
4. Запустите контейнер с базой данных GraphDB:
   ```
   sudo docker compose start
   ```

После этого база данных GraphDB будет готова для работы, и вы сможете приступить к выполнению заданий.



## Загрузка RDF данных

Мы будем использовать данные о фильмах, взятые из учебного пособия, предоставленного GraphDB. Данные доступны в синтаксисе Turtle, распространённом формате для хранения RDF данных, в проекте на GitHub по ссылке <https://raw.githubusercontent.com/gschmutz/nosql-workshop/master/07-working-with-graphdb/data/movies.ttl>. Если вы нажмёте на ссылку, увидите данные, представленные ниже.

![](./images/graphdb-movies-data.png)

Мы будем использовать GraphDB Workbench для загрузки данных. В браузере перейдите по адресу <http://localhost:17200>, чтобы открыть GraphDB Workbench.

![](./images/graphdb-workbench-1.png)

Нажмите на **Create new repository** и выберите **GraphDB Repository**.

![](./images/graphdb-workbench-2.png)

Введите `Movies` в поле **Repository** 

![](./images/graphdb-workbench-3.png)

и нажмите **Create**.

В меню слева нажмите на **Import**.

![](./images/graphdb-import-1.png)

Нажмите на **Movies** и выберите второй вариант **Get RDF data from a URL**.

![](./images/graphdb-import-2.png)

В появившемся окне введите [`https://raw.githubusercontent.com/BosenkoTM/nosql-workshop/refs/heads/main/07-working-with-graphdb/data/movies.ttl`](https://raw.githubusercontent.com/BosenkoTM/nosql-workshop/refs/heads/main/07-working-with-graphdb/data/movies.ttl) в поле.

![](./images/graphdb-import-33.png)

Оставьте выбранным **Start import automatically** и нажмите **Import**. Оставьте значения по умолчанию в другом всплывающем окне и снова нажмите **Import**.

Через несколько секунд ввод должен завершиться успешным сообщением, как показано на следующем снимке экрана.

![](./images/graphdb-import-44.png)

Теперь база данных готова к использованию.

## Обзор графа

Нажмите на **Explore** и **Class hierarchy**.

![](./images/graphdb-explore-1.png)

Мы можем увидеть схему графа фильмов с базовым классом `schema:Movie` и двумя подклассами `imbd:BlackAndWhiteMovie` и `imdb:ColorMovie`.

Нажмите на более крупную внутреннюю окружность, представляющую цветные фильмы.

![](./images/graphdb-explore-2.png)

Мы можем увидеть, что в графе есть `4690` экземпляров цветных фильмов, с отображением нескольких названий фильмов справа.

Вы можете либо напрямую нажать на одно из отображённых названий, либо использовать поиск для нахождения определённого фильма. Давайте введём `matrix`.


![](./images/graphdb-explore-3.png)

Чтобы найти фильм **The Matrix**, введите `matrix`. Нажмите на него, и вы увидите перечисленные связи, которые относятся к этому фильму.

![](./images/graphdb-explore-4.png)

Нажмите **Visual Graph**, чтобы увидеть график визуально.

![](./images/graphdb-explore-5.png)

Преимущество Визуального Графа заключается в том, что вы можете дважды щёлкнуть на одном из узлов, чтобы расширить граф. Давайте попробуем это на актера **KeanuReeves**, и граф должен расшириться, как показано ниже.


![](./images/graphdb-explore-6.png)

Мы можем увидеть все другие фильмы, в которых также снялся Кейну Ривз.

Навигация по графу таким образом имеет некоторые преимущества, но сначала нам нужно найти стартовый узел в нашем графе. Для этого RDF/Triple-хранилище предлагает язык запросов SPARQL.


## Querying the graph using SPARQL

Нажмите на **SPARQL** в навигационном меню слева, и вы перейдёте в представление SPARQL, которое интегрирует [редактор запросов YASGUI](http://about.yasgui.org/) или [редактор запросов YASGUI](https://docs.triply.cc/yasgui/).

![](./images/graphdb-sparql-1.png)

Самый простой оператор выбора SPARQL предварительно заполнен в окне запроса.

```sparql
select * where {
    ?s ?p ?o .
} limit 100
```

Нажмите **Run**, чтобы выполнить запрос. Он выбирает все `триплеты` в графе, но ограничивает результат до 100 записей.

![](./images/graphdb-sparql-2.png)

Если мы хотим показывать только триплет с определённым субъектом, мы можем адаптировать запрос следующим образом:

```sparql
select * where {
    <http://academy.ontotext.com/imdb/title/PiratesoftheCaribbeanAtWorldsEnd> ?p ?o .
}
```
Запрос выбирает RDF-утверждения, чей субъект — фильм "Pirates of the Caribbean: At World's End" (идентифицируемый IRI `http://academy.ontotext.com/imdb/title/PiratesOfTheCaribbeanAtWorldsEnd`).


![](./images/graphdb-sparql-3.png)

Мы можем сократить IRI, установив префикс, как показано ниже:

```sparql
PREFIX imdb: <http://academy.ontotext.com/imdb/>

select * where {
    imdb:title\/PiratesoftheCaribbeanAtWorldsEnd ?p ?o .
}
```

Это более полезно, если один и тот же префикс используется несколько раз.

Обратите внимание, что нужно экранировать `/` в сокращённом IRI.

Переменные `?p` и `?o` соответствуют предикату и объекту RDF-утверждений. Мы видим, что режиссёр (через предикат `schema:director`) идентифицируется IRI `imdb:person/GoreVerbinski` (прокрутите вниз при необходимости).

Следующий запрос выбирает все цветные фильмы по классу (`a` является сокращённой записью для `rdf:type`), а затем выполняет два соединения для получения названия фильма (через предикат `schema:name`) и количества комментариев к фильму (через предикат `schema:commentCount`). Наконец, результат должен быть отсортирован по количеству комментариев в порядке убывания.

```sparql
PREFIX imdb: <http://academy.ontotext.com/imdb/>
PREFIX schema: <http://schema.org/>

SELECT ?movie ?name ?commentCount
WHERE {
  ?movie a imdb:ColorMovie ;
           schema:name ?name ;
           schema:commentCount ?commentCount .
}
ORDER BY DESC(?commentCount)
LIMIT 100
```

```sparql
PREFIX imdb: <http://academy.ontotext.com/imdb/>
PREFIX schema: <http://schema.org/>

SELECT * { 
    ?movie a imdb:ColorMovie ;
           schema:name ?movieName ;
           schema:commentCount ?commentCount .
} ORDER BY DESC(?commentCount)
```

Таблица показывает результаты выполнения запроса.

![](./images/graphdb-sparql-4.png)

Переменные `?movie`, `?name` и `?commentCount` содержат соответственно IRI фильма, название фильма и количество комментариев. Мы видим, что фильм с наибольшим количеством комментариев, "The Dark Knight Rises", находится на вершине списка.

Следующий запрос выбирает RDF-утверждения, которые имеют одинаковый субъект (`?movie`) и одинаковый объект (`?person`). 
Для любого заданного фильма и человека должны существовать RDF-утверждения, связывающие фильм и человека с использованием предикатов `schema:director` и `imdb:leadActor`.

```sparql
PREFIX schema: <http://schema.org/>
PREFIX imdb: <http://academy.ontotext.com/imdb/>

SELECT * { 
	?movie schema:director ?person ;
           imdb:leadActor ?person .
} ORDER BY ?person
```

Таблица показывает результаты выполнения запроса.

![](./images/graphdb-sparql-5.png)

Как и в предыдущем запросе, в следующем запросе мы выбираем фильмы и людей, которые являются как главными актёрами, так и режиссёрами. В этом запросе мы также используем `GROUP BY ?person` для группировки результатов по человеку и `COUNT(?movie)` для подсчёта количества фильмов, удовлетворяющих критериям для каждого человека. Подсчитанное количество возвращается в переменной `?numMovies`.

```sparql
PREFIX schema: <http://schema.org/>
PREFIX imdb: <http://academy.ontotext.com/imdb/>

SELECT ?person (COUNT(?movie) as ?numMovies) { 
	?movie schema:director ?person ;
           imdb:leadActor ?person .
} GROUP BY ?person ORDER BY DESC(?numMovies)
```

Таблица показывает результаты выполнения запроса.

![](./images/graphdb-sparql-6.png)

Так как мы также использовали `ORDER BY DESC(?numMovies)` для сортировки результатов по количеству фильмов в порядке убывания, мы легко можем увидеть, что как Клинт Иствуд, так и Уоди Аллен снялись в 10 фильмах, где они были как главными актёрами, так и режиссёрами.

```sparql
PREFIX imdb: <http://academy.ontotext.com/imdb/>
PREFIX schema: <http://schema.org/>

SELECT ?person ?personName (COUNT(?movie) AS ?numMovies)
WHERE {
  ?movie schema:name ?name ;
           schema:director ?person ;
           imdb:leadActor ?person .
  ?person schema:name ?personName .
}
GROUP BY ?person ?personName
ORDER BY DESC(?numMovies)
LIMIT 100
```

## Индивидуальные задания

Выполнить задание согласно своего варианта на [портале Практическая работа 4.2 Рекомендательные системы. GraphDB](http://95.31.0.249/moodle/mod/assign/view.php?id=1504).

| Вариант | Задание 1                                                                                  | Задание 2                                                                                             | Задание 3                                                                                             | Задание 4                                                                                             | Задание 5                                                                                           |
|---------|--------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|
| 1       | Загрузите данные о фильмах в GraphDB из файла RDF.                                          | Найдите все фильмы, у которых количество комментариев больше 100.                                    | Сортируйте фильмы по имени и выведите 10 первых.                                                     | Получите список всех актеров, снимавшихся в фильме "The Matrix".                                     | Найдите режиссеров, которые также являются главными актерами.                                       |
| 2       | Используя SPARQL, выберите все фильмы с определенным режиссером.                            | Найдите фильмы, где главный актер и режиссер — одно и то же лицо.                                     | Выведите все фильмы, снятые в черно-белом формате.                                                   | Получите список всех фильмов с рейтингом выше 8,0.                                                    | Выведите список всех людей, участвующих в фильмах, и количество их фильмов.                        |
| 3       | Создайте запрос, который находит все фильмы, снятые в 1990-е годы.                          | Напишите запрос для получения всех фильмов с их актерами и режиссерами.                             | Найдите все фильмы с более чем 5 актерами в главных ролях.                                           | Найдите фильмы, в которых снялся "Keanu Reeves" и выведите их по убыванию количества комментариев. | Сортируйте фильмы по году выпуска и выводите только первые 5 фильмов.                               |
| 4       | Напишите запрос, который вернет все фильмы, у которых количество комментариев больше 200.  | Создайте запрос для отображения всех фильмов, выпущенных в 2000-е годы.                              | Найдите режиссеров, которые сняли больше 5 фильмов.                                                  | Выведите все фильмы, в которых снимался "Johnny Depp".                                               | Напишите запрос, который сортирует фильмы по году выпуска и количеству комментариев.               |
| 5       | Напишите запрос для получения всех фильмов с их жанром (если имеется).                     | Найдите все фильмы с цветной съемкой и количеством комментариев больше 100.                           | Создайте запрос для получения всех фильмов и их актеров.                                             | Напишите запрос для получения количества фильмов, снятых в разных жанрах.                           | Получите список всех фильмов и режиссеров, которые сняли более 10 фильмов.                         |
| 6       | Создайте запрос для нахождения всех фильмов, в которых снимались два актера.                | Напишите запрос для нахождения всех фильмов с черно-белой съемкой.                                  | Получите список всех актеров, снимавшихся в фильме "The Matrix".                                     | Напишите запрос для получения всех фильмов с количеством комментариев больше 500.                  | Найдите все фильмы, режиссеры которых снялись в 5 или более фильмах как актеры.                    |
| 7       | Создайте запрос для получения списка всех фильмов и их режиссеров.                          | Найдите все фильмы, у которых количество комментариев меньше 50.                                      | Выведите все фильмы, для которых рейтинг выше 7,0.                                                  | Напишите запрос для поиска всех фильмов, выпущенных в 2010-е годы.                                  | Получите список всех фильмов, у которых одинаковые актеры и режиссеры.                              |
| 8       | Создайте запрос для поиска всех фильмов, в которых участвовали актеры из "The Matrix".       | Выведите список всех фильмов, снятых в жанре комедия.                                               | Напишите запрос, который выводит все фильмы с актерами "Tom Hanks" и "Meryl Streep".                | Сортируйте фильмы по количеству комментариев в порядке убывания и покажите первые 10.               | Найдите все фильмы, у которых главными актерами являются актеры из "The Matrix".                    |
| 9       | Найдите все фильмы, для которых количество комментариев больше 1000.                        | Напишите запрос для получения списка всех фильмов и их жанров.                                       | Создайте запрос для поиска всех фильмов, снятых до 1980 года.                                        | Выведите все фильмы с наибольшим количеством комментариев.                                           | Найдите все фильмы, у которых актер и режиссер совпадают.                                          |
| 10      | Найдите все фильмы, у которых имя режиссера начинается с буквы "C".                          | Напишите запрос, который найдет все фильмы с участием актера "Leonardo DiCaprio".                    | Найдите все фильмы, в которых снимались оба актера: "Will Smith" и "Tommy Lee Jones".               | Напишите запрос для получения всех фильмов, в которых участвовал "Bruce Willis".                    | Найдите фильмы, которые были сняты режиссером "Christopher Nolan".                                 |
| 11      | Напишите запрос для получения всех фильмов с их количеством комментариев.                  | Создайте запрос для поиска всех фильмов с рейтингом выше 9,0.                                         | Найдите все фильмы, в которых сыграл "Keanu Reeves" и режиссером был "Lana Wachowski".                | Напишите запрос для поиска всех фильмов, выпущенных в 1990-е годы.                                  | Найдите все фильмы, у которых актер и режиссер — один и тот же человек.                            |
| 12      | Создайте запрос, который вернет все фильмы, снятые в 1980-е годы.                            | Напишите запрос, который выберет все фильмы, снятые в жанре фантастика.                             | Найдите все фильмы с названием, начинающимся на "The".                                              | Выведите все фильмы, в которых снимались актёры "Robert Downey Jr." и "Chris Hemsworth".            | Напишите запрос для получения списка всех фильмов с их рейтингом.                                  |
| 13      | Найдите все фильмы, снятые до 1970 года.                                                    | Напишите запрос для получения всех фильмов с рейтингом 7 и выше.                                     | Найдите все фильмы, в которых снимались два актера: "Scarlett Johansson" и "Chris Evans".            | Создайте запрос для получения всех фильмов, снятых в жанре триллер.                                  | Напишите запрос для получения всех фильмов и их жанра, отсортировав по году.                       |
| 14      | Напишите запрос для получения всех фильмов, выпущенных в 2015 году.                         | Создайте запрос для поиска всех фильмов с участием "Johnny Depp" и "Helena Bonham Carter".           | Найдите все фильмы с количеством комментариев меньше 50.                                            | Напишите запрос для получения всех фильмов, для которых актер и режиссер одинаковы.                 | Сортируйте все фильмы по количеству комментариев и году выпуска.                                   |
| 15      | Напишите запрос для получения всех фильмов, которые сняты в 1990-е годы.                    | Найдите фильмы, в которых главными актерами являются "Tom Cruise" и "Nicole Kidman".                | Создайте запрос для нахождения всех фильмов, в которых снимались "Brad Pitt" и "Angelina Jolie".     | Найдите все фильмы, у которых количество комментариев больше 100, но меньше 500.                    | Напишите запрос, который вернет только те фильмы, которые вышли после 2010 года.                   |
| 16      | Создайте запрос, который вернет все фильмы, снятые в черно-белом формате.                    | Найдите фильмы с количеством комментариев больше 1000.                                               | Выведите все фильмы, снятые до 2000 года.                                                           | Напишите запрос для получения всех фильмов с рейтингом меньше 5.0.                                   | Сортируйте все фильмы по количеству комментариев в порядке возрастания.                            |
| 17      | Напишите запрос для нахождения всех фильмов, у которых количество комментариев меньше 500. | Найдите все фильмы, которые были сняты режиссером "James Cameron".                                  | Напишите запрос для нахождения всех фильмов, где играли актеры "Brad Pitt" и "Edward Norton".        | Выведите все фильмы, где снимались "Dwayne Johnson" и "Vin Diesel".                                  | Напишите запрос для нахождения всех фильмов с большим количеством комментариев.                    |
| 18      | Найдите все фильмы, в которых снялись "Angelina Jolie" и "Brad Pitt".                        | Напишите запрос для получения всех фильмов, снятых в 2000-х годах.                                   | Выведите все фильмы, у которых главный актер и режиссер совпадают.                                  | Найдите все фильмы с более чем 1000 комментариями.                                                   | Создайте запрос для поиска всех фильмов, выпущенных в жанре драма.                                 |
| 19      | Напишите запрос для получения всех фильмов, в которых снялись "Keanu Reeves" и "Laurence Fishburne". | Найдите все фильмы, где актеры и режиссеры совпадают.                                                | Выведите все фильмы, которые сняты в жанре боевик и имеют рейтинг выше 7.0.                           | Найдите все фильмы с количеством комментариев больше 1000.                                           | Напишите запрос, который выведет список фильмов, отсортированных по количеству комментариев.      |
| 20      | Напишите запрос для нахождения всех фильмов с участием "Leonardo DiCaprio".                  | Создайте запрос для получения всех фильмов, снятых после 2000 года.                                  | Найдите все фильмы, которые имеют рейтинг выше 9.0.                                                  | Выведите все фильмы, которые сняты в жанре ужасов.                                                   | Напишите запрос для получения списка всех фильмов с их годом выпуска.                             |
| 21      | Найдите все фильмы с количеством комментариев больше 200.                                    | Напишите запрос для поиска всех фильмов с участием "Tom Hanks".                                     | Найдите все фильмы с количеством комментариев меньше 50.                                            | Напишите запрос для получения всех фильмов с количеством актеров больше 5.                         | Найдите все фильмы с главными актерами, снявшимися в 5 и более фильмах.                           |
| 22      | Напишите запрос для нахождения всех фильмов с рейтингом меньше 5.0.                          | Найдите все фильмы, где снимались "Meryl Streep" и "Robert Redford".                                 | Напишите запрос, который находит все фильмы, снятые до 1980 года.                                   | Найдите все фильмы с количеством комментариев больше 500.                                            | Создайте запрос для вывода фильмов, у которых количество комментариев больше 200, но меньше 1000. |
| 23      | Напишите запрос для поиска всех фильмов с участием "Morgan Freeman".                         | Найдите все фильмы, которые были сняты после 2010 года.                                              | Выведите все фильмы, которые сняты в жанре фэнтези.                                                 | Найдите все фильмы, у которых рейтинг меньше 6,0 и количество комментариев меньше 100.              | Напишите запрос для вывода всех фильмов, снятых в 2000-х годах.                                    |
| 24      | Найдите все фильмы, которые вышли до 1990 года.                                             | Напишите запрос, который вернет все фильмы с количеством комментариев больше 500.                    | Выведите все фильмы с участием "Natalie Portman".                                                  | Найдите все фильмы, в которых снялся "Keanu Reeves".                                                 | Напишите запрос для поиска всех фильмов, выпущенных в жанре приключения.                          |
| 25      | Напишите запрос для поиска всех фильмов, где снялись "Tom Hanks" и "Julia Roberts".           | Создайте запрос для поиска всех фильмов, где главными актерами являются "Nicole Kidman" и "Tom Cruise". | Найдите все фильмы, которые были сняты до 1980 года.                                               | Найдите все фильмы, у которых количество комментариев больше 100.                                    | Напишите запрос для получения списка всех фильмов и их жанров.                                     |
| 26      | Напишите запрос для поиска всех фильмов с рейтингом выше 8.0.                                 | Найдите все фильмы, в которых снимался "Brad Pitt".                                                | Выведите все фильмы с наибольшим количеством комментариев.                                           | Найдите все фильмы, снятые в жанре ужасы и имеющие рейтинг выше 6.0.                                  | Найдите все фильмы, в которых снимались "Robert Downey Jr." и "Chris Hemsworth".                   |
| 27      | Напишите запрос для получения всех фильмов с рейтингом выше 7.0.                              | Найдите все фильмы, в которых снимались "Johnny Depp" и "Helena Bonham Carter".                      | Найдите все фильмы, снятые до 1980 года.                                                           | Выведите все фильмы, у которых актер и режиссер — одно и то же лицо.                                 | Напишите запрос для нахождения всех фильмов, у которых количество комментариев больше 1000.       |
| 28      | Напишите запрос для получения всех фильмов с количеством комментариев меньше 100.            | Создайте запрос для нахождения всех фильмов с рейтингом 7.0 и выше.                                  | Найдите все фильмы, у которых актер и режиссер совпадают.                                          | Напишите запрос для поиска всех фильмов, у которых актер и режиссер — одно и то же лицо.            | Напишите запрос для нахождения всех фильмов, снятых после 2000 года.                              |
| 29      | Напишите запрос для получения всех фильмов, у которых рейтинг ниже 5.0.                      | Создайте запрос для нахождения всех фильмов с количеством комментариев выше 500.                     | Выведите все фильмы, у которых главные актеры были номинированы на "Оскар".                          | Найдите все фильмы, выпущенные до 1990 года и имеющие рейтинг выше 7.0.                              | Напишите запрос для нахождения всех фильмов, снятых в жанре драма и имеющих рейтинг 6.0 и выше.    |
| 30      | Напишите запрос для получения всех фильмов, в которых снимался "Keanu Reeves".                | Найдите все фильмы, где актерами и режиссерами являются одни и те же люди.                         | Напишите запрос для нахождения всех фильмов с их количеством комментариев.                          | Найдите все фильмы, у которых рейтинг больше 8.0.                                                    | Напишите запрос для вывода всех фильмов, отсортированных по количеству комментариев.              |




**Что требуется загрузить на портал:**

1. **Отчет** — в котором будет описан весь процесс работы с GraphDB, включая настройку, загрузку данных, выполнение запросов и анализ полученных результатов.
2. **Файл с запросами** — содержащий выполненные SPARQL-запросы, которые использовались для работы с данными (например, запросы для выборки фильмов, режиссеров, актеров и т.д.).

Загрузите эти два файла в соответствующий раздел на портале Moodle.

